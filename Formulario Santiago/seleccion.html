<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="style.css">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecciona tu comida</title>
</head>
<body>
    <main class="card card-seleccion">
        <h1>Frecuencia de consumo</h1>
        <p class="subtitulo" id="mensajeFrecuencia"></p>
        <div id="contenedorSelectores"></div>
        <section id="resumenFrecuencia" class="resumen-frecuencia">
            <h2>Resumen de consumo</h2>
            <ol id="resultadoSeleccion"></ol>
            <p id="estadoFrecuencia"></p>
        </section>
        <div id="bloquePuntuacion" class="bloque-puntuacion oculto">
            <h2 id="tituloPuntuacion"></h2>
            <p class="subtexto-puntuacion">Punt√∫a de peor (1) a mejor (5)</p>
            <div id="opcionesPuntuacion" class="opciones-puntuacion"></div>
            <p id="resultadoPuntuacion"></p>
        </div>
        <a href="index.html" class="btn-volver" id="btnVolver">Volver a la p√°gina principal</a>
    </main>

    <script>
        const contenedor = document.getElementById('contenedorSelectores');
        const mensajeFrecuencia = document.getElementById('mensajeFrecuencia');
        const resultado = document.getElementById('resultadoSeleccion');
        const estadoFrecuencia = document.getElementById('estadoFrecuencia');
        const bloquePuntuacion = document.getElementById('bloquePuntuacion');
        const tituloPuntuacion = document.getElementById('tituloPuntuacion');
        const opcionesPuntuacion = document.getElementById('opcionesPuntuacion');
        const resultadoPuntuacion = document.getElementById('resultadoPuntuacion');
        const btnVolver = document.getElementById('btnVolver');

        const comidasGuardadas = JSON.parse(localStorage.getItem('comidasGuardadas') || '[]');
        const nombreUsuario = localStorage.getItem('nombreUsuario') || 'usuario';

        mensajeFrecuencia.textContent = `Bueno, ${nombreUsuario} ahora vas a definir con qu√© frecuencia consumes los alimentos que ingresaste previamente.`;

        if (!Array.isArray(comidasGuardadas) || comidasGuardadas.length < 5) {
            contenedor.innerHTML = '<p>No hay 5 comidas guardadas. Primero regresa al formulario principal.</p>';
            estadoFrecuencia.textContent = 'Primero agrega las comidas en la p√°gina principal.';
        } else {
            const selectoresFrecuencia = [];
            const opcionesFrecuencia = [
                '1 vez por semana',
                '2 veces por semana',
                '3 o m√°s veces por semana',
                '1 vez por mes',
                '2 veces por mes',
                '3 o m√°s veces por mes',
            ];

            const pesosFrecuencia = {
                '1 vez por mes': 1,
                '2 veces por mes': 2,
                '3 o m√°s veces por mes': 3,
                '1 vez por semana': 4,
                '2 veces por semana': 5,
                '3 o m√°s veces por semana': 6,
            };

            function construirPuntuacion(comidaMasFrecuente) {
                bloquePuntuacion.classList.remove('oculto');
                tituloPuntuacion.textContent = `Punt√∫a esta comida: ${comidaMasFrecuente}`;
                opcionesPuntuacion.innerHTML = '';
                resultadoPuntuacion.textContent = '';

                for (let i = 1; i <= 5; i++) {
                    const boton = document.createElement('button');
                    boton.type = 'button';
                    boton.className = `btn-puntuacion nivel-${i}`;
                    boton.textContent = `${i} ${'üçî'.repeat(i)}`;

                    boton.addEventListener('click', () => {
                        const botones = document.querySelectorAll('.btn-puntuacion');
                        botones.forEach((item) => item.classList.remove('activo'));
                        boton.classList.add('activo');
                        resultadoPuntuacion.textContent = `Calificaste "${comidaMasFrecuente}" con ${i}/5.`;
                    });

                    opcionesPuntuacion.appendChild(boton);
                }
            }

            function ocultarPuntuacion(mensaje) {
                bloquePuntuacion.classList.add('oculto');
                opcionesPuntuacion.innerHTML = '';
                resultadoPuntuacion.textContent = '';
                estadoFrecuencia.textContent = mensaje || '';
            }

            function obtenerIndiceMasFrecuente() {
                const puntajes = selectoresFrecuencia.map((selector) => pesosFrecuencia[selector.value] || 0);
                const mayor = Math.max(...puntajes);
                const indicesMaximos = puntajes
                    .map((valor, index) => ({ valor, index }))
                    .filter((item) => item.valor === mayor)
                    .map((item) => item.index);

                if (indicesMaximos.length !== 1) {
                    return null;
                }

                return indicesMaximos[0];
            }

            for (let i = 0; i < 5; i++) {
                const etiqueta = document.createElement('label');
                etiqueta.setAttribute('for', `selectorFrecuencia${i + 1}`);
                etiqueta.textContent = `${comidasGuardadas[i]}:`;

                const selectorFrecuencia = document.createElement('select');
                selectorFrecuencia.id = `selectorFrecuencia${i + 1}`;
                selectorFrecuencia.name = `selectorFrecuencia${i + 1}`;

                opcionesFrecuencia.forEach((frecuencia) => {
                    const opcion = document.createElement('option');
                    opcion.value = frecuencia;
                    opcion.textContent = frecuencia;
                    selectorFrecuencia.appendChild(opcion);
                });

                contenedor.appendChild(etiqueta);
                contenedor.appendChild(selectorFrecuencia);
                contenedor.appendChild(document.createElement('br'));
                contenedor.appendChild(document.createElement('br'));

                selectoresFrecuencia.push(selectorFrecuencia);
            }

            function actualizarResumen() {
                const indiceMasFrecuente = obtenerIndiceMasFrecuente();

                resultado.innerHTML = '';
                selectoresFrecuencia.forEach((selector, index) => {
                    const item = document.createElement('li');
                    const esMasFrecuente = indiceMasFrecuente === index;
                    item.textContent = esMasFrecuente
                        ? `${comidasGuardadas[index]}: ${selector.value} ‚≠ê`
                        : `${comidasGuardadas[index]}: ${selector.value}`;
                    resultado.appendChild(item);
                });

                if (indiceMasFrecuente === null) {
                    ocultarPuntuacion('Hay empate en frecuencia, ajusta para habilitar la puntuaci√≥n.');
                    return;
                }

                estadoFrecuencia.textContent = '‚≠ê indica la comida que vas a calificar.';
                construirPuntuacion(comidasGuardadas[indiceMasFrecuente]);
            }
            selectoresFrecuencia.forEach((selector) => {
                selector.addEventListener('change', actualizarResumen);
            });

            actualizarResumen();
        }

        btnVolver.addEventListener('click', (event) => {
            const confirmarSalida = confirm(
                '‚ö†Ô∏è Si sales ahora, se borrar√° todo el progreso y los datos almacenados.\nTendr√°s que volver a ingresarlos desde cero.\n\n¬øDeseas continuar?'
            );

            if (!confirmarSalida) {
                event.preventDefault();
                return;
            }

            localStorage.removeItem('comidasGuardadas');
            localStorage.removeItem('nombreUsuario');
        });
    </script>
</body>
</html>